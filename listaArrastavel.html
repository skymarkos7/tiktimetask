<!DOCTYPE html>
<html>
<head>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/sortablejs@1.10.2/Sortable.min.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.10.2/Sortable.min.js"></script>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"
  />
</head>
<body>
  <div class="div-centralizada">
    <input type="text" id="input-descricao" placeholder="Digite a descrição" />
    <button class="margin" onclick="adicionarItem()">Adicionar</button>
  </div>

  <hr class="margin">

  <div class="container">
    <table id="sortable-table">
      <thead>
        <tr>
          <th></th>
          <th>Ação</th>
          <th>Descrição</th>
          <th>Tempo</th>
        </tr>
      </thead>
      <tbody id="table-body">
        <tr>
          <td class="drag-handle">&#9776;</td>
          <td>
            <i class="fa fa-play play-icon" onclick="startTimer(this)"></i>
          </td>
          <td ondblclick="editarDescricao(this)">Descrição 1</td>
          <td>00:00</td>
        </tr>
        <tr>
          <td class="drag-handle">&#9776;</td>
          <td>
            <i class="fa fa-play play-icon" onclick="startTimer(this)"></i>
          </td>
          <td ondblclick="editarDescricao(this)">Descrição 2</td>
          <td>00:00</td>
        </tr>
      </tbody>
    </table>
  </div>

  <hr class="margin">

  <div class="container">
    <table id="time-log-table">
      <thead>
        <tr>
          <th>Data</th>
          <th>Início</th>
          <th>Fim</th>
          <th>SGP</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="time-log-body">
      </tbody>
    </table>
  </div>

  <script>
    const sortableTable = Sortable.create(
      document.getElementById('sortable-table').getElementsByTagName('tbody')[0],
      {
        handle: '.drag-handle',
        animation: 150,
      }
    );

    function adicionarItem() {
      const descricao = document.getElementById('input-descricao').value;
      if (descricao.trim() !== '') {
        const tabela = document.getElementById('table-body');

        const newRow = document.createElement('tr');
        tabela.insertBefore(newRow, tabela.firstChild);

        const dragCell = document.createElement('td');
        dragCell.innerHTML = '&#9776;';
        dragCell.className = 'drag-handle';
        newRow.appendChild(dragCell);

        const acaoCell = document.createElement('td');
        const playIcon = document.createElement('i');
        playIcon.classList.add('fa', 'fa-play', 'play-icon');
        playIcon.onclick = function () {
          startTimer(this);
        };
        acaoCell.appendChild(playIcon);
        newRow.appendChild(acaoCell);

        const descricaoCell = document.createElement('td');
        descricaoCell.textContent = descricao;
        descricaoCell.ondblclick = function () {
          editarDescricao(this);
        };
        newRow.appendChild(descricaoCell);

        const tempoCell = document.createElement('td');
        tempoCell.textContent = '00:00';
        newRow.appendChild(tempoCell);

        document.getElementById('input-descricao').value = ''; // Limpa o campo de entrada após adicionar o item
      }
    }

    document.getElementById('input-descricao').addEventListener('keydown', function (event) {
      if (event.key === 'Enter') {
        adicionarItem();
      }
    });

    function startTimer(icon) {
      const row = icon.parentNode.parentNode;
      const tempoCell = row.cells[3];
      let tempo = tempoCell.innerText;
      let [minutes, seconds] = tempo.split(':');
      minutes = parseInt(minutes);
      seconds = parseInt(seconds);

      const intervalId = setInterval(() => {
        seconds++;
        if (seconds === 60) {
          seconds = 0;
          minutes++;
        }
        tempo = `${padZero(minutes)}:${padZero(seconds)}`;
        tempoCell.innerText = tempo;
      }, 1000);

      // Armazena o intervalId para poder parar o contador posteriormente
      row.dataset.intervalId = intervalId.toString();

      // Armazena a data e a hora de início
      row.dataset.startDate = getCurrentDate();
      row.dataset.startTime = getCurrentTime();

      // Altera o ícone para o ícone de pausa
      icon.classList.remove('fa-play');
      icon.classList.remove('play-icon');
      icon.classList.add('fa-pause', 'pause-icon');
      icon.onclick = function () {
        pauseTimer(this);
      };
    }

    function pauseTimer(icon) {
      const row = icon.parentNode.parentNode;
      const intervalId = parseInt(row.dataset.intervalId);

      clearInterval(intervalId);

      // Armazena a hora de fim
      row.dataset.endTime = getCurrentTime();

      // Preencher o horário de fim e calcular SGP e Total
      const startTime = row.dataset.startTime;
      const endTime = row.dataset.endTime;

      const sgp = calculateSGP(startTime, endTime);
      const total = calculateTotal(startTime, endTime);

      const currentDate = getCurrentDate();
      const currentStartTime = getCurrentTime();

      const timeLogRow = document.createElement('tr');
      document.getElementById('time-log-body').appendChild(timeLogRow);

      const dateLogCell = document.createElement('td');
      dateLogCell.textContent = currentDate;
      timeLogRow.appendChild(dateLogCell);

      const startLogCell = document.createElement('td');
      startLogCell.textContent = currentStartTime;
      timeLogRow.appendChild(startLogCell);

      const endLogCell = document.createElement('td');
      endLogCell.textContent = endTime;
      timeLogRow.appendChild(endLogCell);

      const sgpLogCell = document.createElement('td');
      sgpLogCell.textContent = sgp;
      timeLogRow.appendChild(sgpLogCell);

      const totalLogCell = document.createElement('td');
      totalLogCell.textContent = total;
      timeLogRow.appendChild(totalLogCell);

      // Altera o ícone para o ícone de play
      icon.classList.remove('fa-pause');
      icon.classList.remove('pause-icon');
      icon.classList.add('fa-play', 'play-icon');
      icon.onclick = function () {
        startTimer(this);
      };
    }

    function padZero(num) {
      return num.toString().padStart(2, '0');
    }

    function editarDescricao(cell) {
      if (cell.parentNode.rowIndex === 1) {
        return; // Ignora a primeira linha
      }

      const descricao = cell.textContent;

      const input = document.createElement('input');
      input.type = 'text';
      input.value = descricao;
      input.addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
          cell.textContent = input.value;
          input.parentNode.replaceChild(cell, input);
        }
      });

      cell.textContent = '';
      cell.appendChild(input);
      input.focus();
    }

    function getCurrentDate() {
      const date = new Date();
      const year = date.getFullYear();
      const month = padZero(date.getMonth() + 1);
      const day = padZero(date.getDate());
      return `${day}/${month}/${year}`;
    }

    function getCurrentTime() {
      const date = new Date();
      const hours = padZero(date.getHours());
      const minutes = padZero(date.getMinutes());
      const seconds = padZero(date.getSeconds());
      return `${hours}:${minutes}:${seconds}`;
    }

    function calculateSGP(startTime, endTime) {
      // Cálculo do SGP (Segundos de Gerência de Projetos)
      const start = new Date(`01/01/2000 ${startTime}`);
      const end = new Date(`01/01/2000 ${endTime}`);
      const diff = Math.abs(end - start) / 1000;
      return Math.floor(diff % 60);
    }

    function calculateTotal(startTime, endTime) {
      // Cálculo do Total
      const start = new Date(`01/01/2000 ${startTime}`);
      const end = new Date(`01/01/2000 ${endTime}`);
      const diff = Math.abs(end - start) / 1000;
      const minutes = Math.floor(diff / 60);
      const seconds = Math.floor(diff % 60);
      return `${padZero(minutes)}:${padZero(seconds)}`;
    }
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    .div-centralizada {
      text-align: center;
    }

    .margin {
      margin-top: 20px;
      margin-bottom: 20px;
    }

    .container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 800px;
    }

    th,
    td {
      text-align: left;
      padding: 8px;
    }

    th {
      background-color: #f2f2f2;
    }

    tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    .drag-handle {
      cursor: move;
    }

    .play-icon {
      color: green;
      cursor: pointer;
    }

    .pause-icon {
      color: red;
      cursor: pointer;
    }
  </style>
</body>
</html>
