<!DOCTYPE html>
<html>
<head>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/sortablejs@1.10.2/Sortable.min.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.10.2/Sortable.min.js"></script>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"
  />
</head>
<body>
  <div class="div-centralizada">
    <input type="text" id="input-descricao" placeholder="Digite a descrição" />
    <button class="margin" onclick="adicionarItem()">Adicionar</button>
  </div>

  <hr class="margin">

  <div class="container">
    <table id="sortable-table">
      <thead>
        <tr>
          <th></th>
          <th>Ação</th>
          <th>Descrição</th>
          <th>Tempo</th>
        </tr>
      </thead>
      <tbody id="table-body">
        <tr>
          <td class="drag-handle">&#9776;</td>
          <td>
            <i class="fa fa-play play-icon" onclick="startTimer(this)"></i>
          </td>
          <td ondblclick="editarDescricao(this)">Descrição 1</td>
          <td>00:00</td>
        </tr>
        <tr>
          <td class="drag-handle">&#9776;</td>
          <td>
            <i class="fa fa-play play-icon" onclick="startTimer(this)"></i>
          </td>
          <td ondblclick="editarDescricao(this)">Descrição 2</td>
          <td>00:00</td>
        </tr>
      </tbody>
    </table>
  </div>

  <hr class="margin">

  <div class="container">
    <table id="time-log-table">
      <thead>
        <tr>
          <th>Data</th>
          <th>Início</th>
          <th>Fim</th>
          <th>SGP</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="time-log-body">
      </tbody>
    </table>
  </div>

  <script>
    const sortableTable = Sortable.create(
      document.getElementById('sortable-table').getElementsByTagName('tbody')[0],
      {
        handle: '.drag-handle',
        animation: 150,
      }
    );

    function adicionarItem() {
      const descricao = document.getElementById('input-descricao').value;
      if (descricao.trim() !== '') {
        const tabela = document.getElementById('table-body');

        const newRow = document.createElement('tr');
        tabela.insertBefore(newRow, tabela.firstChild);

        const dragCell = document.createElement('td');
        dragCell.innerHTML = '&#9776;';
        dragCell.className = 'drag-handle';
        newRow.appendChild(dragCell);

        const acaoCell = document.createElement('td');
        const playIcon = document.createElement('i');
        playIcon.classList.add('fa', 'fa-play', 'play-icon');
        playIcon.onclick = function () {
          startTimer(this);
        };
        acaoCell.appendChild(playIcon);
        newRow.appendChild(acaoCell);

        const descricaoCell = document.createElement('td');
        descricaoCell.textContent = descricao;
        descricaoCell.ondblclick = function () {
          editarDescricao(this);
        };
        newRow.appendChild(descricaoCell);

        const tempoCell = document.createElement('td');
        tempoCell.textContent = '00:00';
        newRow.appendChild(tempoCell);
      }
    }

    function startTimer(icon) {
      const row = icon.parentNode.parentNode;
      const tempoCell = row.cells[3];
      let tempo = tempoCell.innerText;
      let [minutes, seconds] = tempo.split(':');
      minutes = parseInt(minutes);
      seconds = parseInt(seconds);

      const intervalId = setInterval(() => {
        seconds++;
        if (seconds === 60) {
          seconds = 0;
          minutes++;
        }
        tempo = `${padZero(minutes)}:${padZero(seconds)}`;
        tempoCell.innerText = tempo;
      }, 1000);

      // Armazena o intervalId para poder parar o contador posteriormente
      row.dataset.intervalId = intervalId.toString();

      // Armazena a data e a hora de início
      row.dataset.startDate = getCurrentDate();
      row.dataset.startTime = getCurrentTime();

      // Altera o ícone para o ícone de pausa
      icon.classList.remove('fa-play');
      icon.classList.remove('play-icon');
      icon.classList.add('fa-pause', 'pause-icon');
      icon.onclick = function () {
        pauseTimer(this);
      };
    }

    function pauseTimer(icon) {
      const row = icon.parentNode.parentNode;
      const intervalId = parseInt(row.dataset.intervalId);

      clearInterval(intervalId);

      // Armazena a hora de fim
      row.dataset.endTime = getCurrentTime();

      // Preencher o horário de fim e calcular SGP e Total
      const startTime = row.dataset.startTime;
      const endTime = row.dataset.endTime;
      row.cells[2].textContent = endTime;

      const sgp = calculateSGP(startTime, endTime);
      const total = calculateTotal(startTime, endTime);

      const currentDate = getCurrentDate();
      const currentStartTime = getCurrentTime();

      const timeLogRow = document.createElement('tr');
      document.getElementById('time-log-body').appendChild(timeLogRow);

      const dateLogCell = document.createElement('td');
      dateLogCell.textContent = currentDate;
      timeLogRow.appendChild(dateLogCell);

      const startLogCell = document.createElement('td');
      startLogCell.textContent = currentStartTime;
      timeLogRow.appendChild(startLogCell);

      const endLogCell = document.createElement('td');
      endLogCell.textContent = endTime;
      timeLogRow.appendChild(endLogCell);

      const sgpLogCell = document.createElement('td');
      sgpLogCell.textContent = sgp;
      timeLogRow.appendChild(sgpLogCell);

      const totalLogCell = document.createElement('td');
      totalLogCell.textContent = total;
      timeLogRow.appendChild(totalLogCell);
    }

    function padZero(num) {
      return num.toString().padStart(2, '0');
    }

    function editarDescricao(cell) {
      const descricao = cell.textContent;

      const input = document.createElement('input');
      input.type = 'text';
      input.value = descricao;
      input.classList.add('edit-input');

      input.addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
          cell.textContent = input.value;
          input.parentNode.removeChild(input);
        } else if (event.key === 'Escape') {
          input.parentNode.removeChild(input);
        }
      });

      cell.textContent = '';
      cell.appendChild(input);
      input.focus();
    }

    function getCurrentDate() {
      const date = new Date();
      const year = date.getFullYear();
      const month = padZero(date.getMonth() + 1);
      const day = padZero(date.getDate());
      return `${year}-${month}-${day}`;
    }

    function getCurrentTime() {
      const date = new Date();
      const hours = padZero(date.getHours());
      const minutes = padZero(date.getMinutes());
      const seconds = padZero(date.getSeconds());
      return `${hours}:${minutes}:${seconds}`;
    }

    function calculateSGP(startTime, endTime) {
      const start = parseTime(startTime);
      const end = parseTime(endTime);
      const duration = end - start;
      return Math.floor(duration / 60);
    }

    function calculateTotal(startTime, endTime) {
      const start = parseTime(startTime);
      const end = parseTime(endTime);
      const duration = end - start;
      const minutes = Math.floor(duration / 60);
      const seconds = duration % 60;
      return `${padZero(minutes)}:${padZero(seconds)}`;
    }

    function parseTime(time) {
      const [hours, minutes, seconds] = time.split(':');
      return parseInt(hours) * 3600 + parseInt(minutes) * 60 + parseInt(seconds);
    }
  </script>

  <style>
    .container {
      max-width: 500px;
      margin: 0 auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    .drag-handle {
      cursor: move;
    }

    .div-centralizada {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
    }

    .edit-input {
      width: 100%;
    }

    .margin {
      margin: 10px;
    }

    .play-icon {
      color: green;
    }

    .pause-icon {
      color: red;
    }
  </style>
</body>
</html>
